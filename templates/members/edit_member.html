
{% extends 'base.html' %}

{% block title %}Edit Member - RuweHolyGhostChurch{% endblock %}

{% block page_title %}Edit Member - {{ member.full_name }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-user-edit" style="color: #dc2626; margin-right: 10px;"></i>
            Edit Member - {{ member.full_name }}
        </h5>
        <div style="float: right;">
            <a href="{% url 'members:member_detail' member.username %}" class="btn btn-info btn-sm">
                <i class="fas fa-eye"></i> View Details
            </a>
            <a href="{% url 'members:index' %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Back to Members
            </a>
        </div>
    </div>

    <form method="POST" style="margin-top: 20px;" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Personal Information Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-user" style="margin-right: 8px;"></i>
                Personal Information
            </h6>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">First Name *</label>
                    <input type="text" name="first_name" value="{{ member.first_name }}" required placeholder="e.g., Lawi"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Last Name *</label>
                    <input type="text" name="last_name" value="{{ member.last_name }}" required placeholder="e.g., Obonyo"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Username *</label>
                    <input type="text" name="username" value="{{ member.username }}" required placeholder="e.g., lawi_obonyo"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Date of Birth *</label>
                    <input type="date" name="date_of_birth" value="{{ member.date_of_birth|date:'Y-m-d' }}" id="date_of_birth" required onchange="calculateUserGroup()"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">User Group (Auto-calculated) *</label>
                    <input type="text" id="user_group_display" value="{{ member.user_group }}" readonly
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #2d3748; color: #ffffff; border-radius: 4px;">
                    <input type="hidden" name="user_group" id="user_group" value="{{ member.user_group }}" required>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Gender *</label>
                    <select name="gender" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Gender</option>
                        <option value="M" {% if member.gender == 'M' %}selected{% endif %}>Male</option>
                        <option value="F" {% if member.gender == 'F' %}selected{% endif %}>Female</option>
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Marital Status *</label>
                    <select name="marital_status" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Marital Status</option>
                        <option value="single" {% if member.marital_status == 'single' %}selected{% endif %}>Single</option>
                        <option value="married" {% if member.marital_status == 'married' %}selected{% endif %}>Married</option>
                        <option value="divorced" {% if member.marital_status == 'divorced' %}selected{% endif %}>Divorced</option>
                        <option value="widowed" {% if member.marital_status == 'widowed' %}selected{% endif %}>Widowed</option>
                        <option value="separated" {% if member.marital_status == 'separated' %}selected{% endif %}>Separated</option>
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Location *</label>
                    <input type="text" name="location" value="{{ member.location }}" required placeholder="e.g., Nairobi, Kenya"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Education Level *</label>
                    <select name="education_level" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Education Level</option>
                        <option value="primary" {% if member.education_level == 'primary' %}selected{% endif %}>Primary Education</option>
                        <option value="secondary" {% if member.education_level == 'secondary' %}selected{% endif %}>Secondary Education</option>
                        <option value="certificate" {% if member.education_level == 'certificate' %}selected{% endif %}>Certificate</option>
                        <option value="diploma" {% if member.education_level == 'diploma' %}selected{% endif %}>Diploma</option>
                        <option value="bachelor" {% if member.education_level == 'bachelor' %}selected{% endif %}>Bachelor's Degree</option>
                        <option value="master" {% if member.education_level == 'master' %}selected{% endif %}>Master's Degree</option>
                        <option value="phd" {% if member.education_level == 'phd' %}selected{% endif %}>PhD</option>
                        <option value="other" {% if member.education_level == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
            </div>

            <!-- Member Roles Section -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="color: #ffffff; margin-bottom: 8px; display: block;">Member Roles *</label>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="regular_member" id="role_regular" class="form-check-input" checked disabled>
                            <label for="role_regular" class="form-check-label" style="color: #ffffff;">Regular Member (Default)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="singer" id="role_singer" class="form-check-input" {% if 'singer' in member.member_roles %}checked{% endif %}>
                            <label for="role_singer" class="form-check-label" style="color: #ffffff;">Singer</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="drum_percussionist" id="role_drum" class="form-check-input" {% if 'drum_percussionist' in member.member_roles %}checked{% endif %}>
                            <label for="role_drum" class="form-check-label" style="color: #ffffff;">Drum Percussionist</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="shaker_percussionist" id="role_shaker" class="form-check-input" {% if 'shaker_percussionist' in member.member_roles %}checked{% endif %}>
                            <label for="role_shaker" class="form-check-label" style="color: #ffffff;">Shaker Percussionist</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="synod_representative" id="role_synod" class="form-check-input" {% if 'synod_representative' in member.member_roles %}checked{% endif %}>
                            <label for="role_synod" class="form-check-label" style="color: #ffffff;">Synod Representative</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="clergy" id="role_clergy" class="form-check-input" onchange="toggleClergyRoles()" {% if 'clergy' in member.member_roles %}checked{% endif %}>
                            <label for="role_clergy" class="form-check-label" style="color: #ffffff;">Clergy</label>
                        </div>
                    </div>
                    <!-- Hidden input to ensure regular_member is always submitted -->
                    <input type="hidden" name="member_roles" value="regular_member">
                </div>
            </div>

            <!-- Church/Dean Clergy Roles Section -->
            <div id="church_clergy_section" class="form-group" style="margin-bottom: 20px; {% if 'clergy' not in member.member_roles %}display: none;{% endif %}">
                <label style="color: #ffffff; margin-bottom: 8px; display: block;">Church/Dean Clergy Roles</label>
                <div style="background: rgba(220, 38, 38, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #dc2626;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        {% for role_code, role_label in church_clergy_roles %}
                        <div class="form-check">
                            <input type="checkbox" name="church_clergy_roles" value="{{ role_code }}" id="church_clergy_{{ role_code }}" class="form-check-input" onchange="enforceSingleChurchClergy(this)" {% if role_code in member.church_clergy_roles %}checked{% endif %}>
                            <label for="church_clergy_{{ role_code }}" class="form-check-label" style="color: #ffffff;">{{ role_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Special Clergy Roles Section -->
            <div id="special_clergy_section" class="form-group" style="margin-bottom: 20px; {% if 'clergy' not in member.member_roles %}display: none;{% endif %}">
                <label style="color: #ffffff; margin-bottom: 8px; display: block;">Special Clergy Roles</label>
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ffd700;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        {% for role_code, role_label in special_clergy_roles %}
                        <div class="form-check">
                            <input type="checkbox" name="special_clergy_roles" value="{{ role_code }}" id="special_clergy_{{ role_code }}" class="form-check-input" onchange="enforceSingleSpecialClergy(this)" {% if role_code in member.special_clergy_roles %}checked{% endif %}>
                            <label for="special_clergy_{{ role_code }}" class="form-check-label" style="color: #ffffff;">{{ role_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-phone" style="margin-right: 8px;"></i>
                Contact Information
            </h6>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Phone Number *</label>
                    <input type="tel" name="phone_number" value="{{ member.phone_number }}" required placeholder="e.g., +254708581688"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Email Address</label>
                    <input type="email" name="email_address" value="{{ member.email_address }}" placeholder="e.g., lawifirst@gmail.com"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
            </div>

            <!-- Membership Status -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; margin-bottom: 15px;">
                <div class="col-md-4">
                    <label for="membership_status" class="form-label" style="color: #ffffff; margin-bottom: 5px; display: block;">Membership Status <span class="text-danger">*</span></label>
                    <select class="form-select" id="membership_status" name="membership_status" required
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        {% for value, display in membership_statuses %}
                        <option value="{{ value }}" {% if member.membership_status == value %}selected{% endif %}>{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="is_staff" class="form-label" style="color: #ffffff; margin-bottom: 5px; display: block;">Staff Status <span class="text-danger">*</span></label>
                    <select class="form-select" id="is_staff" name="is_staff" required
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="No" {% if not member.is_staff %}selected{% endif %}>No</option>
                        <option value="Yes" {% if member.is_staff %}selected{% endif %}>Yes</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="is_ordained" class="form-label" style="color: #ffffff; margin-bottom: 5px; display: block;">Hand Ordination Status <span class="text-danger">*</span></label>
                    <select class="form-select" id="is_ordained" name="is_ordained" required
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="No" {% if not member.is_ordained %}selected{% endif %}>No</option>
                        <option value="Yes" {% if member.is_ordained %}selected{% endif %}>Yes</option>
                    </select>
                </div>
            </div>

            <!-- Person with Disability -->
            <div class="row" style="margin-top: 15px;">
                <div class="col-md-4">
                    <label for="is_pwd" class="form-label">Person with Disability (PWD) <span class="text-danger">*</span></label>
                    <select class="form-select" id="is_pwd" name="is_pwd" onchange="togglePwdFields()" required
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="No" {% if not member.is_pwd %}selected{% endif %}>No</option>
                        <option value="Yes" {% if member.is_pwd %}selected{% endif %}>Yes</option>
                    </select>
                </div>
                <div class="col-md-4" id="pwd_type_field" style="{% if not member.is_pwd %}display: none;{% endif %}">
                    <label for="pwd_type" class="form-label">Type of Disability</label>
                    <select class="form-select" id="pwd_type" name="pwd_type" style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select type...</option>
                        {% for value, display in pwd_types %}
                        <option value="{{ value }}" {% if member.pwd_type == value %}selected{% endif %}>{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4" id="pwd_other_field" style="{% if not member.is_pwd or member.pwd_type != 'other' %}display: none;{% endif %}">
                    <label for="pwd_other_description" class="form-label">Other Disability Description</label>
                    <textarea class="form-control" id="pwd_other_description" name="pwd_other_description" rows="2" placeholder="Please specify if comfortable...">{{ member.pwd_other_description }}</textarea>
                </div>
            </div>
        </div>

        <!-- Rest of the form sections can be added here similar to add_member.html -->
        <!-- For brevity, I'm including the key sections. You can copy the remaining sections from add_member.html -->

        <!-- Form Actions -->
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #374151;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px; margin-right: 15px;">
                <i class="fas fa-save" style="margin-right: 8px;"></i>
                Update Member
            </button>
            <a href="{% url 'members:member_detail' member.username %}" class="btn btn-secondary" style="padding: 12px 30px;">
                <i class="fas fa-times" style="margin-right: 8px;"></i>
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
// Include all the JavaScript functions from add_member.html
// PWD Fields Toggle, Member Roles Toggle, etc.

// Calculate user group based on date of birth
function calculateUserGroup() {
    const dateOfBirth = document.getElementById('date_of_birth').value;
    const userGroupDisplay = document.getElementById('user_group_display');
    const userGroupHidden = document.getElementById('user_group');
    
    if (dateOfBirth) {
        const birthYear = new Date(dateOfBirth).getFullYear();
        const currentYear = new Date().getFullYear();
        const age = currentYear - birthYear;
        
        let userGroup = '';
        let userGroupLabel = '';
        
        if (age >= 18 && age <= 35) {
            userGroup = 'Youth';
            userGroupLabel = 'Youth (18-35 years)';
        } else if (age >= 36 && age <= 60) {
            userGroup = 'Adult';
            userGroupLabel = 'Adult (36-60 years)';
        } else if (age >= 61) {
            userGroup = 'Elder';
            userGroupLabel = 'Elder (61+ years)';
        } else {
            userGroup = '';
            userGroupLabel = 'Age must be 18 or above';
        }
        
        userGroupDisplay.value = userGroupLabel;
        userGroupHidden.value = userGroup;
        
        // Add visual feedback for invalid age
        if (age < 18) {
            userGroupDisplay.style.color = '#ef4444';
            userGroupDisplay.style.borderColor = '#ef4444';
        } else {
            userGroupDisplay.style.color = '#22c55e';
            userGroupDisplay.style.borderColor = '#22c55e';
        }
    } else {
        userGroupDisplay.value = '';
        userGroupHidden.value = '';
        userGroupDisplay.style.color = '#ffffff';
        userGroupDisplay.style.borderColor = '#374151';
    }
}

// PWD Fields Toggle
function togglePwdFields() {
    const isPwd = document.getElementById('is_pwd').value === 'Yes';
    const pwdTypeField = document.getElementById('pwd_type_field');
    const pwdOtherField = document.getElementById('pwd_other_field');

    if (isPwd) {
        pwdTypeField.style.display = 'block';
        document.getElementById('pwd_type').addEventListener('change', function() {
            pwdOtherField.style.display = this.value === 'other' ? 'block' : 'none';
        });
    } else {
        pwdTypeField.style.display = 'none';
        pwdOtherField.style.display = 'none';
        document.getElementById('pwd_type').value = '';
        document.getElementById('pwd_other_description').value = '';
    }
}

// Member Roles Toggle
function toggleClergyRoles() {
    const isClergy = document.getElementById('role_clergy').checked;
    const churchClergySection = document.getElementById('church_clergy_section');
    const specialClergySection = document.getElementById('special_clergy_section');

    if (isClergy) {
        churchClergySection.style.display = 'block';
        specialClergySection.style.display = 'block';
    } else {
        churchClergySection.style.display = 'none';
        specialClergySection.style.display = 'none';
        // Uncheck all clergy roles when the main clergy checkbox is unchecked
        const clergyCheckboxes = document.querySelectorAll('input[name="church_clergy_roles"], input[name="special_clergy_roles"]');
        clergyCheckboxes.forEach(checkbox => checkbox.checked = false);
    }
}

// Single selection enforcement for Church Clergy Roles
function enforceSingleChurchClergy(selectedCheckbox) {
    const churchClergyCheckboxes = document.querySelectorAll('input[name="church_clergy_roles"]');
    if (selectedCheckbox.checked) {
        churchClergyCheckboxes.forEach(checkbox => {
            if (checkbox !== selectedCheckbox) {
                checkbox.checked = false;
            }
        });
    }
}

// Single selection enforcement for Special Clergy Roles
function enforceSingleSpecialClergy(selectedCheckbox) {
    const specialClergyCheckboxes = document.querySelectorAll('input[name="special_clergy_roles"]');
    if (selectedCheckbox.checked) {
        specialClergyCheckboxes.forEach(checkbox => {
            if (checkbox !== selectedCheckbox) {
                checkbox.checked = false;
            }
        });
    }
}

// Initialize page state
document.addEventListener('DOMContentLoaded', function() {
    // Trigger pwd field visibility if pwd is selected
    togglePwdFields();
    
    // Trigger clergy roles visibility if clergy is selected
    if (document.getElementById('role_clergy').checked) {
        toggleClergyRoles();
    }
});
</script>
{% endblock %}
