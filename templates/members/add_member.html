{% extends 'base.html' %}

{% block title %}Add Member - RuweHolyGhostChurch{% endblock %}

{% block page_title %}Add New Member{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-user-plus" style="color: #dc2626; margin-right: 10px;"></i>
            Member Registration Form
        </h5>
    </div>

    <form method="POST" style="margin-top: 20px;" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Personal Information Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-user" style="margin-right: 8px;"></i>
                Personal Information
            </h6>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">First Name *</label>
                    <input type="text" name="first_name" required placeholder="e.g., Lawi"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Last Name *</label>
                    <input type="text" name="last_name" required placeholder="e.g., Obonyo"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Username *</label>
                    <input type="text" name="username" required placeholder="e.g., lawi_obonyo"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">User Group *</label>
                    <select name="user_group" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Group</option>
                        {% for value, label in user_groups %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Gender *</label>
                    <select name="gender" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Date of Birth *</label>
                    <input type="date" name="date_of_birth" required
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Marital Status *</label>
                    <select name="marital_status" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Marital Status</option>
                        <option value="single">Single</option>
                        <option value="married">Married</option>
                        <option value="divorced">Divorced</option>
                        <option value="widowed">Widowed</option>
                        <option value="separated">Separated</option>
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Location *</label>
                    <select name="location" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Location</option>
                        <option value="siaya">Siaya</option>
                        <option value="nairobi">Nairobi</option>
                        <option value="kisumu">Kisumu</option>
                        <option value="mombasa">Mombasa</option>
                        <option value="nakuru">Nakuru</option>
                        <option value="eldoret">Eldoret</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Education Level *</label>
                    <select name="education_level" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Education Level</option>
                        <option value="primary">Primary Education</option>
                        <option value="secondary">Secondary Education</option>
                        <option value="certificate">Certificate</option>
                        <option value="diploma">Diploma</option>
                        <option value="bachelor">Bachelor's Degree</option>
                        <option value="master">Master's Degree</option>
                        <option value="phd">PhD</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Member Roles Section -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="color: #ffffff; margin-bottom: 8px; display: block;">Member Roles *</label>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="regular_member" id="role_regular" class="form-check-input" checked disabled>
                            <label for="role_regular" class="form-check-label" style="color: #ffffff;">Regular Member (Default)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="singer" id="role_singer" class="form-check-input">
                            <label for="role_singer" class="form-check-label" style="color: #ffffff;">Singer</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="drum_percussionist" id="role_drum" class="form-check-input">
                            <label for="role_drum" class="form-check-label" style="color: #ffffff;">Drum Percussionist</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="shaker_percussionist" id="role_shaker" class="form-check-input">
                            <label for="role_shaker" class="form-check-label" style="color: #ffffff;">Shaker Percussionist</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="synod_representative" id="role_synod" class="form-check-input">
                            <label for="role_synod" class="form-check-label" style="color: #ffffff;">Synod Representative</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="member_roles" value="clergy" id="role_clergy" class="form-check-input" onchange="toggleClergyRoles()">
                            <label for="role_clergy" class="form-check-label" style="color: #ffffff;">Clergy</label>
                        </div>
                    </div>
                    <!-- Hidden input to ensure regular_member is always submitted -->
                    <input type="hidden" name="member_roles" value="regular_member">
                </div>
            </div>

            <!-- Church/Dean Clergy Roles Section -->
            <div id="church_clergy_section" class="form-group" style="margin-bottom: 20px; display: none;">
                <label style="color: #ffffff; margin-bottom: 8px; display: block;">Church/Dean Clergy Roles</label>
                <div style="background: rgba(220, 38, 38, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #dc2626;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        {% for role_code, role_label in church_clergy_roles %}
                        <div class="form-check">
                            <input type="checkbox" name="church_clergy_roles" value="{{ role_code }}" id="church_clergy_{{ role_code }}" class="form-check-input" onchange="enforceSingleChurchClergy(this)">
                            <label for="church_clergy_{{ role_code }}" class="form-check-label" style="color: #ffffff;">{{ role_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Special Clergy Roles Section -->
            <div id="special_clergy_section" class="form-group" style="margin-bottom: 20px; display: none;">
                <label style="color: #ffffff; margin-bottom: 8px; display: block;">Special Clergy Roles</label>
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ffd700;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        {% for role_code, role_label in special_clergy_roles %}
                        <div class="form-check">
                            <input type="checkbox" name="special_clergy_roles" value="{{ role_code }}" id="special_clergy_{{ role_code }}" class="form-check-input" onchange="enforceSingleSpecialClergy(this)">
                            <label for="special_clergy_{{ role_code }}" class="form-check-label" style="color: #ffffff;">{{ role_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-phone" style="margin-right: 8px;"></i>
                Contact Information
            </h6>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Phone Number *</label>
                    <input type="tel" name="phone_number" required placeholder="e.g., +254708581688"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Email Address *</label>
                    <input type="email" name="email_address" required placeholder="e.g., lawifirst@gmail.com"
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
            </div>

            <!-- Membership Status -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; margin-bottom: 15px;">
                <div class="col-md-4">
                    <label for="membership_status" class="form-label" style="color: #ffffff; margin-bottom: 5px; display: block;">Membership Status <span class="text-danger">*</span></label>
                    <select class="form-select" id="membership_status" name="membership_status" required 
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        {% for value, display in membership_statuses %}
                        <option value="{{ value }}" {% if value == 'Active' %}selected{% endif %}>{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="is_staff" class="form-label" style="color: #ffffff; margin-bottom: 5px; display: block;">Staff Status <span class="text-danger">*</span></label>
                    <select class="form-select" id="is_staff" name="is_staff" required 
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="No" selected>No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="is_ordained" class="form-label" style="color: #ffffff; margin-bottom: 5px; display: block;">Hand Ordination Status <span class="text-danger">*</span></label>
                    <select class="form-select" id="is_ordained" name="is_ordained" required 
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="No" selected>No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
            </div>

            <!-- Person with Disability -->
            <div class="row" style="margin-top: 15px;">
                <div class="col-md-4">
                    <label for="is_pwd" class="form-label">Person with Disability (PWD) <span class="text-danger">*</span></label>
                    <select class="form-select" id="is_pwd" name="is_pwd" onchange="togglePwdFields()" required 
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="No" selected>No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                <div class="col-md-4" id="pwd_type_field" style="display: none;">
                    <label for="pwd_type" class="form-label">Type of Disability</label>
                    <select class="form-select" id="pwd_type" name="pwd_type" style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select type...</option>
                        {% for value, display in pwd_types %}
                        <option value="{{ value }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4" id="pwd_other_field" style="display: none;">
                    <label for="pwd_other_description" class="form-label">Other Disability Description</label>
                    <textarea class="form-control" id="pwd_other_description" name="pwd_other_description" rows="2" placeholder="Please specify if comfortable..."></textarea>
                </div>
            </div>
        </div>

        <!-- Family Details -->
        <div class="form-section" style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-users" style="margin-right: 10px; color: #dc2626;"></i>
                Family Details (Optional)
            </h6>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Search and select family members by username, email, or phone number</p>

            <div class="row">
                <div class="col-md-6">
                    <label for="father" class="form-label">Father</label>
                    <select class="form-select member-select" id="father" name="father">
                        <option value="">Select Father...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="mother" class="form-label">Mother</label>
                    <select class="form-select member-select" id="mother" name="mother">
                        <option value="">Select Mother...</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label for="guardian" class="form-label">Guardian</label>
                    <select class="form-select member-select" id="guardian" name="guardian">
                        <option value="">Select Guardian...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="brother" class="form-label">Brother</label>
                    <select class="form-select member-select" id="brother" name="brother">
                        <option value="">Select Brother...</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label for="sister" class="form-label">Sister</label>
                    <select class="form-select member-select" id="sister" name="sister">
                        <option value="">Select Sister...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="uncle" class="form-label">Uncle</label>
                    <select class="form-select member-select" id="uncle" name="uncle">
                        <option value="">Select Uncle...</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label for="aunt" class="form-label">Aunt</label>
                    <select class="form-select member-select" id="aunt" name="aunt">
                        <option value="">Select Aunt...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="friend" class="form-label">Friend</label>
                    <select class="form-select member-select" id="friend" name="friend">
                        <option value="">Select Friend...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Emergency Contact Information Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                Emergency Contact Information
            </h6>

            <div style="margin-bottom: 20px;">
                <h7 style="color: #f3f4f6; margin-bottom: 10px; display: block; font-weight: bold;">Emergency Contact 1</h7>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Name</label>
                        <input type="text" name="emergency_contact_1_name" placeholder="e.g., Alfayo Odongo Mango"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Relationship</label>
                        <input type="text" name="emergency_contact_1_relationship" placeholder="e.g., Parent, Spouse, Sibling"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Phone</label>
                        <input type="tel" name="emergency_contact_1_phone" placeholder="e.g., +254712345678"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Email</label>
                        <input type="email" name="emergency_contact_1_email" placeholder="e.g., alfayomango@gmail.com"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <div>
                <h7 style="color: #f3f4f6; margin-bottom: 10px; display: block; font-weight: bold;">Emergency Contact 2 (Optional)</h7>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Name</label>
                        <input type="text" name="emergency_contact_2_name"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Relationship</label>
                        <input type="text" name="emergency_contact_2_relationship" placeholder="e.g., Parent, Spouse, Sibling"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Phone</label>
                        <input type="tel" name="emergency_contact_2_phone"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #ffffff; margin-bottom: 5px; display: block;">Email</label>
                        <input type="email" name="emergency_contact_2_email"
                               style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Photo Management Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-image" style="margin-right: 8px;"></i>
                Profile Photo
            </h6>

            <div>
                <label style="color: #ffffff; margin-bottom: 5px; display: block;">Upload Photo</label>
                <input type="file" name="profile_photo" accept="image/*"
                       style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
            </div>
        </div>

        <!-- Job/Occupation Information Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-briefcase" style="margin-right: 8px;"></i>
                Job & Occupation Information
            </h6>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="color: #ffffff; margin-bottom: 8px; display: block;">Select Job/Occupation Roles (Multiple selections allowed)</label>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                    {% regroup job_choices by 0|slice:":1"|first as grouped_jobs %}
                    {% for category_code, category_label in job_categories %}
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: #22c55e; margin-bottom: 10px; font-weight: bold;">{{ category_label }}</h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px; margin-left: 15px;">
                            {% for job_code, job_label in job_choices %}
                                {% if category_code == "agriculture_agribusiness" and job_code|slice:":11" == "smallholder_" or job_code|slice:":10" == "agronomist" or job_code|slice:":4" == "farm" or job_code|slice:":9" == "livestock" or job_code|slice:":12" == "agribusiness" or job_code|slice:":4" == "agro" or job_code|slice:":12" == "agricultural" or job_code|slice:":7" == "produce" or job_code|slice:":4" == "food" or job_code|slice:":10" == "irrigation" %}
                                <div class="form-check">
                                    <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                    <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                </div>
                                {% elif category_code == "healthcare_medical" and job_code|slice:":5" == "nurse" or job_code|slice:":8" == "clinical" or job_code|slice:":9" == "community" or job_code|slice:":9" == "pharmacist" or job_code|slice:":3" == "lab" or job_code|slice:":13" == "physiotherapist" or job_code|slice:":7" == "medical" or job_code|slice:":6" == "health" or job_code|slice:":6" == "dental" or job_code|slice:":4" == "xray" or job_code|slice:":12" == "nutritionist" or job_code|slice:":12" == "psychologist" or job_code|slice:":12" == "orthopaedic" %}
                                <div class="form-check">
                                    <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                    <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                </div>
                                {% elif category_code == "education_training" and job_code|slice:":7" == "primary" or job_code|slice:":9" == "secondary" or job_code|slice:":10" == "university" or job_code|slice:":5" == "early" or job_code|slice:":2" == "pe" or job_code|slice:":7" == "private" or job_code|slice:":10" == "curriculum" or job_code|slice:":8" == "training" or job_code|slice:":9" == "librarian" or job_code|slice:":9" == "education" %}
                                <div class="form-check">
                                    <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                    <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                </div>
                                {% elif category_code == "finance_banking_insurance" and job_code|slice:":4" == "bank" or job_code|slice:":10" == "accountant" or job_code|slice:":6" == "credit" or job_code|slice:":9" == "financial" or job_code|slice:":12" == "microfinance" or job_code|slice:":9" == "insurance" or job_code|slice:":3" == "tax" or job_code|slice:":8" == "treasury" or job_code|slice:":7" == "auditor" %}
                                <div class="form-check">
                                    <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                    <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                </div>
                                {% elif category_code == "ict" and job_code|slice:":8" == "software" or job_code|slice:":4" == "data" or job_code|slice:":7" == "network" or job_code|slice:":2" == "it" or job_code|slice:":5" == "ux_ui" or job_code|slice:":6" == "devops" or job_code|slice:":12" == "cybersecurity" or job_code|slice:":2" == "qa" or job_code|slice:":5" == "ai_ml" %}
                                <div class="form-check">
                                    <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                    <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                </div>
                                {% else %}
                                    {% for other_category_code, other_category_label in job_categories %}
                                        {% if category_code == other_category_code %}
                                            {% if category_code == "creative_media_digital" and job_code|slice:":7" == "graphic" or job_code|slice:":7" == "content" or job_code|slice:":6" == "social" or job_code|slice:":12" == "videographer" or job_code|slice:":12" == "photographer" or job_code|slice:":8" == "animator" or job_code|slice:":5" == "radio" or job_code|slice:":10" == "journalist" or job_code|slice:":2" == "pr" %}
                                            <div class="form-check">
                                                <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                                <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                            </div>
                                            {% elif category_code == "sales_retail_customer_service" and job_code|slice:":6" == "retail" or job_code|slice:":5" == "sales" or job_code|slice:":5" == "store" or job_code|slice:":9" == "ecommerce" or job_code|slice:":8" == "customer" or job_code|slice:":6" == "market" or job_code|slice:":9" == "wholesale" or job_code|slice:":6" == "buying" %}
                                            <div class="form-check">
                                                <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                                <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                            </div>
                                            {% elif category_code == "hospitality_tourism_events" and job_code|slice:":5" == "hotel" or job_code|slice:":11" == "housekeeper" or job_code|slice:":4" == "chef" or job_code|slice:":10" == "restaurant" or job_code|slice:":4" == "tour" or job_code|slice:":5" == "event" or job_code|slice:":9" == "bartender" or job_code|slice:":5" == "lodge" %}
                                            <div class="form-check">
                                                <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                                <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                            </div>
                                            {% elif category_code|length > 0 %}
                                            <div class="form-check">
                                                <input type="checkbox" name="job_occupations" value="{{ job_code }}" id="job_{{ job_code }}" class="form-check-input">
                                                <label for="job_{{ job_code }}" class="form-check-label" style="color: #ffffff; font-size: 0.9em;">{{ job_label }}</label>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div style="margin-top: 20px;">
                <label style="color: #ffffff; margin-bottom: 5px; display: block;">Additional Income & Occupation Details (Optional)</label>
                <textarea name="income_details" rows="3" placeholder="Enter additional income information, occupation details, or other relevant information..."
                          style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;"></textarea>
            </div>
        </div>

        <!-- Baptismal Information Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                S<i class="fas fa-cross" style="margin-right: 8px;"></i>
                Baptismal Information
            </h6>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Baptismal First Name *</label>
                    <input type="text" name="baptismal_first_name" required
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Baptismal Last Name *</label>
                    <input type="text" name="baptismal_last_name" required
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Date Baptized *</label>
                    <input type="date" name="date_baptized" required
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Date Joined Religion *</label>
                    <input type="date" name="date_joined_religion" required
                           style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                </div>
            </div>
        </div>

        <!-- Home Church Structure Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">
                <i class="fas fa-home" style="margin-right: 8px;"></i>
                Home Church Structure *
            </h6>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Home Diocese *</label>
                    <select name="user_home_diocese" id="home-diocese-select" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Diocese</option>
                        {% for diocese in dioceses %}
                        <option value="{{ diocese.id }}">{{ diocese.name }} ({{ diocese.country }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Home Pastorate *</label>
                    <select name="user_home_pastorate" id="home-pastorate-select" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Pastorate</option>
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Home Church *</label>
                    <select name="user_home_church" id="home-church-select" required
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Church</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Town Church Structure Section (Optional) -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #6b7280;">
                <i class="fas fa-building" style="margin-right: 8px;"></i>
                Town Church Structure (Optional - for work/education/treatment)
            </h6>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Town Diocese</label>
                    <select name="user_town_diocese" id="town-diocese-select"
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Diocese</option>
                        {% for diocese in dioceses %}
                        <option value="{{ diocese.id }}">{{ diocese.name }} ({{ diocese.country }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Town Pastorate</label>
                    <select name="user_town_pastorate" id="town-pastorate-select"
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Pastorate</option>
                    </select>
                </div>
                <div>
                    <label style="color: #ffffff; margin-bottom: 5px; display: block;">Town Church</label>
                    <select name="user_town_church" id="town-church-select"
                            style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                        <option value="">Select Church</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Custom Fields Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #6b7280;">
                <i class="fas fa-sliders-h" style="margin-right: 8px;"></i>
                Custom Fields Configuration
            </h6>

            <div id="custom-fields-container">
                <!-- Custom fields will be added here dynamically -->
            </div>
            <button type="button" onclick="addCustomField()" class="btn btn-info" style="margin-top: 10px;">
                <i class="fas fa-plus" style="margin-right: 5px;"></i>
                Add Custom Field
            </button>
        </div>

        <!-- Document Attachments Section -->
        <div style="margin-bottom: 30px;">
            <h6 style="color: #ffffff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #6b7280;">
                <i class="fas fa-file-alt" style="margin-right: 8px;"></i>
                Document Attachments
            </h6>

            <div id="documents-container">
                <!-- Document attachments will be added here dynamically -->
            </div>
            <button type="button" onclick="addDocument()" class="btn btn-info" style="margin-top: 10px;">
                <i class="fas fa-plus" style="margin-right: 5px;"></i>
                Add Document
            </button>
        </div>

        <!-- Form Actions -->
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #374151;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px; margin-right: 15px;">
                <i class="fas fa-save" style="margin-right: 8px;"></i>
                Register Member
            </button>
            <a href="{% url 'members:index' %}" class="btn btn-secondary" style="padding: 12px 30px;">
                <i class="fas fa-times" style="margin-right: 8px;"></i>
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
        // PWD Fields Toggle
        function togglePwdFields() {
            const isPwd = document.getElementById('is_pwd').value === 'Yes';
            const pwdTypeField = document.getElementById('pwd_type_field');
            const pwdOtherField = document.getElementById('pwd_other_field');

            if (isPwd) {
                pwdTypeField.style.display = 'block';
                document.getElementById('pwd_type').addEventListener('change', function() {
                    pwdOtherField.style.display = this.value === 'other' ? 'block' : 'none';
                });
            } else {
                pwdTypeField.style.display = 'none';
                pwdOtherField.style.display = 'none';
                document.getElementById('pwd_type').value = '';
                document.getElementById('pwd_other_description').value = '';
            }
        }

        // Member Roles Toggle
        function toggleClergyRoles() {
            const isClergy = document.getElementById('role_clergy').checked;
            const churchClergySection = document.getElementById('church_clergy_section');
            const specialClergySection = document.getElementById('special_clergy_section');

            if (isClergy) {
                churchClergySection.style.display = 'block';
                specialClergySection.style.display = 'block';
            } else {
                churchClergySection.style.display = 'none';
                specialClergySection.style.display = 'none';
                // Uncheck all clergy roles when the main clergy checkbox is unchecked
                const clergyCheckboxes = document.querySelectorAll('input[name="church_clergy_roles"], input[name="special_clergy_roles"]');
                clergyCheckboxes.forEach(checkbox => checkbox.checked = false);
            }
        }

        // Single selection enforcement for Church Clergy Roles
        function enforceSingleChurchClergy(selectedCheckbox) {
            const churchClergyCheckboxes = document.querySelectorAll('input[name="church_clergy_roles"]');
            if (selectedCheckbox.checked) {
                churchClergyCheckboxes.forEach(checkbox => {
                    if (checkbox !== selectedCheckbox) {
                        checkbox.checked = false;
                    }
                });
            }
        }

        // Single selection enforcement for Special Clergy Roles with validation
        function enforceSingleSpecialClergy(selectedCheckbox) {
            const specialClergyCheckboxes = document.querySelectorAll('input[name="special_clergy_roles"]');
            
            if (selectedCheckbox.checked) {
                const selectedRole = selectedCheckbox.value;
                
                // Check if trying to select a special clergy role
                if (['dean_king', 'dean_king_wife', 'dean_archdeacon', 'dean_archdeacon_wife'].includes(selectedRole)) {
                    // Show warning about uniqueness
                    const confirmMsg = `Warning: Only one ${selectedCheckbox.nextElementSibling.textContent} can exist in the entire church system. If you proceed, any existing ${selectedCheckbox.nextElementSibling.textContent} will need to be updated. Are you sure you want to assign this role?`;
                    
                    if (!confirm(confirmMsg)) {
                        selectedCheckbox.checked = false;
                        return;
                    }
                }
                
                // Uncheck other special clergy roles
                specialClergyCheckboxes.forEach(checkbox => {
                    if (checkbox !== selectedCheckbox) {
                        checkbox.checked = false;
                    }
                });
            }
        }


        // Member Search Functionality
        class MemberSearchSelect {
            constructor(selectElement) {
                this.selectElement = selectElement;
                this.searchInput = null;
                this.init();
            }

            init() {
                this.createSearchInput();
                this.bindEvents();
            }

            createSearchInput() {
                const wrapper = document.createElement('div');
                wrapper.className = 'member-search-wrapper';
                wrapper.style.cssText = 'position: relative;';

                this.searchInput = document.createElement('input');
                this.searchInput.type = 'text';
                this.searchInput.className = 'form-control';
                this.searchInput.placeholder = 'Type to search members...';
                this.searchInput.style.cssText = 'margin-bottom: 5px;';

                this.selectElement.parentNode.insertBefore(wrapper, this.selectElement);
                wrapper.appendChild(this.searchInput);
                wrapper.appendChild(this.selectElement);

                this.selectElement.style.display = 'none';
            }

            bindEvents() {
                let timeout;
                this.searchInput.addEventListener('input', (e) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        this.searchMembers(e.target.value);
                    }, 300);
                });

                this.searchInput.addEventListener('focus', () => {
                    if (this.searchInput.value.length >= 2) {
                        this.searchMembers(this.searchInput.value);
                    }
                });
            }

            searchMembers(query) {
                if (query.length < 2) {
                    this.clearResults();
                    return;
                }

                fetch(`/members/api/search/?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        this.displayResults(data);
                    })
                    .catch(error => {
                        console.error('Error searching members:', error);
                    });
            }

            displayResults(members) {
                this.clearResults();

                if (members.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No members found';
                    this.selectElement.appendChild(option);
                    this.selectElement.style.display = 'block';
                    return;
                }

                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.display;
                    this.selectElement.appendChild(option);
                });

                this.selectElement.style.display = 'block';

                this.selectElement.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        this.searchInput.value = selectedOption.textContent;
                        this.selectElement.style.display = 'none';
                    }
                }, { once: true });
            }

            clearResults() {
                this.selectElement.innerHTML = '<option value="">Select...</option>';
                this.selectElement.style.display = 'none';
            }
        }

        // Enhanced Cascading Dropdown Logic
        document.addEventListener('DOMContentLoaded', function() {
            const homeDioceseSelect = document.getElementById('user_home_diocese');
            const homePastorateSelect = document.getElementById('user_home_pastorate');
            const homeChurchSelect = document.getElementById('user_home_church');

            const townDioceseSelect = document.getElementById('user_town_diocese');
            const townPastorateSelect = document.getElementById('user_town_pastorate');
            const townChurchSelect = document.getElementById('user_town_church');

            // Initialize member search selects
            const memberSelects = document.querySelectorAll('.member-select');
            memberSelects.forEach(select => {
                new MemberSearchSelect(select);
            });

            // Cascading dropdown functionality for Home Church Structure
            homeDioceseSelect.addEventListener('change', function() {
                const dioceseId = this.value;
                homePastorateSelect.innerHTML = '<option value="">Select Pastorate</option>';
                homeChurchSelect.innerHTML = '<option value="">Select Church</option>';

                if (dioceseId) {
                    fetch(`/members/api/pastorates/${dioceseId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(pastorate => {
                                const option = document.createElement('option');
                                option.value = pastorate.id;
                                option.textContent = pastorate.name;
                                homePastorateSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error fetching pastorates:', error));
                }
            });

            homePastorateSelect.addEventListener('change', function() {
                const pastorateId = this.value;
                homeChurchSelect.innerHTML = '<option value="">Select Church</option>';

                if (pastorateId) {
                    fetch(`/members/api/churches/${pastorateId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(church => {
                                const option = document.createElement('option');
                                option.value = church.id;
                                option.textContent = church.name;
                                homeChurchSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error fetching churches:', error));
                }
            });

            // Cascading dropdown functionality for Town Church Structure
            townDioceseSelect.addEventListener('change', function() {
                const dioceseId = this.value;
                townPastorateSelect.innerHTML = '<option value="">Select Pastorate</option>';
                townChurchSelect.innerHTML = '<option value="">Select Church</option>';

                if (dioceseId) {
                    fetch(`/members/api/pastorates/${dioceseId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(pastorate => {
                                const option = document.createElement('option');
                                option.value = pastorate.id;
                                option.textContent = pastorate.name;
                                townPastorateSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error fetching pastorates:', error));
                }
            });

            townPastorateSelect.addEventListener('change', function() {
                const pastorateId = this.value;
                townChurchSelect.innerHTML = '<option value="">Select Church</option>';

                if (pastorateId) {
                    fetch(`/members/api/churches/${pastorateId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(church => {
                                const option = document.createElement('option');
                                option.value = church.id;
                                option.textContent = church.name;
                                townChurchSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error fetching churches:', error));
                }
            });
        });


// Custom Fields Management
function addCustomField() {
    const container = document.getElementById('custom-fields-container');
    const newRow = document.createElement('div');
    newRow.className = 'custom-field-row';
    newRow.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 15px;';

    newRow.innerHTML = `
        <div>
            <label style="color: #ffffff; margin-bottom: 5px; display: block;">Field Name</label>
            <input type="text" name="custom_field_names[]" placeholder="e.g., Marital Status, Education Level"
                   style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
        </div>
        <div>
            <label style="color: #ffffff; margin-bottom: 5px; display: block;">Field Value</label>
            <input type="text" name="custom_field_values[]" placeholder="Enter value"
                   style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: end;">
            <button type="button" onclick="removeCustomField(this)"
                    style="padding: 10px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    container.appendChild(newRow);
}

function removeCustomField(button) {
    button.closest('.custom-field-row').remove();
}

// Document Management
function addDocument() {
    const container = document.getElementById('documents-container');
    const newRow = document.createElement('div');
    newRow.className = 'document-row';
    newRow.style.cssText = 'border: 1px solid #374151; padding: 15px; border-radius: 4px; margin-bottom: 15px; background: #1f2937;';

    newRow.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label style="color: #ffffff; margin-bottom: 5px; display: block;">Document Type</label>
                <select name="document_types[]"
                        style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    <option value="">Select Document Type</option>
                    <option value="baptism_certificate">Baptism Certificate</option>
                    <option value="annual_tithe_card">Annual Tithe Card</option>
                    <option value="id_document">ID Document</option>
                    <option value="medical_record">Medical Record</option>
                    <option value="membership_certificate">Membership Certificate</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label style="color: #ffffff; margin-bottom: 5px; display: block;">Document Title</label>
                <input type="text" name="document_titles[]" placeholder="e.g., Baptism Certificate 2023"
                       style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
            </div>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="color: #ffffff; margin-bottom: 5px; display: block;">Description (Optional)</label>
            <textarea name="document_descriptions[]" rows="2" placeholder="Additional notes about this document"
                      style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;"></textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
            <div>
                <label style="color: #ffffff; margin-bottom: 5px; display: block;">Upload Document</label>
                <input type="file" name="document_files[]"
                       style="width: 100%; padding: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
            </div>
            <button type="button" onclick="removeDocument(this)"
                    style="padding: 10px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    container.appendChild(newRow);
}

function removeDocument(button) {
    button.closest('.document-row').remove();
}
</script>
{% endblock %}