
{% extends 'base.html' %}

{% block title %}Church Structure - RuweHolyGhostChurch{% endblock %}

{% block page_title %}Church Structure{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px;">
    <!-- Diocese Management -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-church" style="color: #dc2626; margin-right: 10px;"></i>
                Diocese Management
            </h5>
        </div>
        <div style="margin-top: 20px;">
            <form method="POST" action="{% url 'church_structure:add_diocese' %}" style="margin-bottom: 20px;">
                {% csrf_token %}
                <select name="country" required 
                        style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    <option value="">Select Country</option>
                    <option value="Kenya">Kenya [MAIN]</option>
                    <option value="Uganda">Uganda</option>
                    <option value="Tanzania">Tanzania</option>
                </select>
                <input type="text" name="name" placeholder="Diocese Name" required 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="text" name="bishop_name" placeholder="Bishop Name" required 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="text" name="bishop_phone" placeholder="Bishop Phone (optional)" 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="email" name="bishop_email" placeholder="Bishop Email (optional)" 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Diocese</button>
            </form>
            
            <div class="dioceses-list">
                <h6 style="color: #ffffff; margin-bottom: 10px;">Existing Dioceses ({{ dioceses.count }})</h6>
                {% for diocese in dioceses %}
                <div style="background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                    <strong style="color: #ffffff;">{{ diocese.name }}</strong>
                    <span style="color: #22c55e; font-size: 0.8em; margin-left: 10px;">({{ diocese.identifier }})</span><br>
                    <small style="color: #9ca3af;">{{ diocese.country }} - Bishop: {{ diocese.bishop_name }}</small>
                </div>
                {% empty %}
                <p style="color: #9ca3af; font-style: italic;">No dioceses added yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pastorate Management -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-users" style="color: #dc2626; margin-right: 10px;"></i>
                Pastorate Management
            </h5>
        </div>
        <div style="margin-top: 20px;">
            <form method="POST" action="{% url 'church_structure:add_pastorate' %}" style="margin-bottom: 20px;">
                {% csrf_token %}
                <select name="diocese_id" required 
                        style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    <option value="">Select Diocese</option>
                    {% for diocese in dioceses %}
                    <option value="{{ diocese.id }}">{{ diocese.name }} ({{ diocese.country }})</option>
                    {% endfor %}
                </select>
                <input type="text" name="name" placeholder="Pastorate Name" required 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="text" name="pastor_name" placeholder="Pastor Name" required 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="text" name="pastor_phone" placeholder="Pastor Phone (optional)" 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="email" name="pastor_email" placeholder="Pastor Email (optional)" 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Pastorate</button>
            </form>
            
            <div class="pastorates-list">
                <h6 style="color: #ffffff; margin-bottom: 10px;">Existing Pastorates ({{ pastorates.count }})</h6>
                {% for pastorate in pastorates %}
                <div style="background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                    <strong style="color: #ffffff;">{{ pastorate.name }}</strong><br>
                    <small style="color: #9ca3af;">Pastor: {{ pastorate.pastor_name }}</small><br>
                    <small style="color: #dc2626;">Diocese: {{ pastorate.diocese.name }}</small>
                </div>
                {% empty %}
                <p style="color: #9ca3af; font-style: italic;">No pastorates added yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Church Management -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-home" style="color: #dc2626; margin-right: 10px;"></i>
                Church Management
            </h5>
        </div>
        <div style="margin-top: 20px;">
            <form method="POST" action="{% url 'church_structure:add_church' %}" style="margin-bottom: 20px;">
                {% csrf_token %}
                <select name="diocese" id="diocese-select" required 
                        style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    <option value="">Select Diocese</option>
                    {% for diocese in dioceses %}
                    <option value="{{ diocese.id }}">{{ diocese.name }}</option>
                    {% endfor %}
                </select>
                <select name="pastorate_id" id="pastorate-select" required 
                        style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                    <option value="">Select Pastorate</option>
                </select>
                <input type="text" name="name" placeholder="Church Name" required 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="text" name="address" placeholder="Church Address" required 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="text" name="head_teacher_name" placeholder="Head Teacher Name" required 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="text" name="head_teacher_phone" placeholder="Head Teacher Phone (optional)" 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <input type="email" name="head_teacher_email" placeholder="Head Teacher Email (optional)" 
                       style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px;">
                <textarea name="service_times" placeholder="Service Times (e.g., Saturday 9:00 AM)" 
                          style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #374151; background: #1f2937; color: #ffffff; border-radius: 4px; min-height: 60px;"></textarea>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Church</button>
            </form>
            
            <div class="churches-list">
                <h6 style="color: #ffffff; margin-bottom: 10px;">Existing Churches ({{ churches.count }})</h6>
                {% for church in churches %}
                <div style="background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                    <strong style="color: #ffffff;">{{ church.name }}</strong><br>
                    <small style="color: #9ca3af;">{{ church.address }} - Head Teacher: {{ church.head_teacher_name }}</small><br>
                    <small style="color: #dc2626;">Pastorate: {{ church.pastorate.name }}</small>
                </div>
                {% empty %}
                <p style="color: #9ca3af; font-style: italic;">No churches added yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Professional Church Structure Table -->
<div class="card" style="margin-top: 30px;">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-sitemap" style="color: #dc2626; margin-right: 10px;"></i>
            Church Hierarchical Structure Overview
        </h5>
    </div>
    <div style="margin-top: 20px;">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="background: #dc2626; color: white; padding: 15px; border-radius: 8px; display: inline-block;">
                <i class="fas fa-crown" style="margin-right: 10px;"></i>
                <strong>HEADQUARTERS - RUWE</strong><br>
                <small>Archbishop Leadership</small>
            </div>
        </div>
        
        {% if dioceses %}
        <div class="table-responsive">
            <table class="table table-dark table-striped" style="background: #1f2937;">
                <thead style="background: #dc2626;">
                    <tr>
                        <th style="padding: 15px; color: white; border: 1px solid #374151;">
                            <i class="fas fa-church" style="margin-right: 8px;"></i>
                            Diocese
                        </th>
                        <th style="padding: 15px; color: white; border: 1px solid #374151;">
                            <i class="fas fa-users" style="margin-right: 8px;"></i>
                            Pastorate
                        </th>
                        <th style="padding: 15px; color: white; border: 1px solid #374151;">
                            <i class="fas fa-home" style="margin-right: 8px;"></i>
                            Church
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for diocese in dioceses %}
                        {% for pastorate in diocese.pastorates.all %}
                            {% for church in pastorate.churches.all %}
                            <tr>
                                {% if forloop.parentloop.first and forloop.first %}
                                <td style="padding: 12px; border: 1px solid #374151; vertical-align: top; background: rgba(220, 38, 38, 0.1);" 
                                    rowspan="{{ diocese.pastorates.all|length }}">
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #ffffff; font-size: 1.1em;">{{ diocese.name }}</strong><br>
                                        <small style="color: #9ca3af;">{{ diocese.country }}</small><br>
                                        <small style="color: #e5e7eb;">Bishop: {{ diocese.bishop_name }}</small>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <a href="{% url 'church_structure:diocese_detail' diocese_slug=diocese.slug %}" 
                                           class="btn btn-sm" style="background: #3b82f6; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="View Diocese Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'church_structure:edit_diocese' diocese_slug=diocese.slug %}" 
                                           class="btn btn-sm" style="background: #f59e0b; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Edit Diocese">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'church_structure:delete_diocese' diocese_slug=diocese.slug %}" 
                                           class="btn btn-sm" style="background: #ef4444; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Delete Diocese"
                                           onclick="return confirm('Are you sure you want to delete this diocese?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                                {% endif %}
                                
                                {% if forloop.first %}
                                <td style="padding: 12px; border: 1px solid #374151; vertical-align: top; background: rgba(59, 130, 246, 0.1);" 
                                    rowspan="{{ pastorate.churches.all|length }}">
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #ffffff; font-size: 1.05em;">{{ pastorate.name }}</strong><br>
                                        <small style="color: #e5e7eb;">Pastor: {{ pastorate.pastor_name }}</small>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <a href="{% url 'church_structure:pastorate_detail' pastorate_slug=pastorate.slug %}" 
                                           class="btn btn-sm" style="background: #3b82f6; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="View Pastorate Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'church_structure:edit_pastorate' pastorate_slug=pastorate.slug %}" 
                                           class="btn btn-sm" style="background: #f59e0b; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Edit Pastorate">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'church_structure:delete_pastorate' pastorate_slug=pastorate.slug %}" 
                                           class="btn btn-sm" style="background: #ef4444; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Delete Pastorate"
                                           onclick="return confirm('Are you sure you want to delete this pastorate?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                                {% endif %}
                                
                                <td style="padding: 12px; border: 1px solid #374151; background: rgba(16, 185, 129, 0.1);">
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #ffffff;">{{ church.name }}</strong><br>
                                        <small style="color: #9ca3af;">{{ church.address }}</small><br>
                                        <small style="color: #e5e7eb;">Head Teacher: {{ church.head_teacher_name }}</small>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <a href="{% url 'church_structure:church_detail' church_slug=church.slug %}" 
                                           class="btn btn-sm" style="background: #3b82f6; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="View Church Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'church_structure:edit_church' church_slug=church.slug %}" 
                                           class="btn btn-sm" style="background: #f59e0b; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Edit Church">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'church_structure:delete_church' church_slug=church.slug %}" 
                                           class="btn btn-sm" style="background: #ef4444; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Delete Church"
                                           onclick="return confirm('Are you sure you want to delete this church?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                {% if forloop.parentloop.first and forloop.first %}
                                <td style="padding: 12px; border: 1px solid #374151; vertical-align: top; background: rgba(220, 38, 38, 0.1);" 
                                    rowspan="{{ diocese.pastorates.all|length }}">
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #ffffff; font-size: 1.1em;">{{ diocese.name }}</strong><br>
                                        <small style="color: #9ca3af;">{{ diocese.country }}</small><br>
                                        <small style="color: #e5e7eb;">Bishop: {{ diocese.bishop_name }}</small>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <a href="{% url 'church_structure:diocese_detail' diocese_slug=diocese.slug %}" 
                                           class="btn btn-sm" style="background: #3b82f6; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="View Diocese Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'church_structure:edit_diocese' diocese_slug=diocese.slug %}" 
                                           class="btn btn-sm" style="background: #f59e0b; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Edit Diocese">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'church_structure:delete_diocese' diocese_slug=diocese.slug %}" 
                                           class="btn btn-sm" style="background: #ef4444; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Delete Diocese"
                                           onclick="return confirm('Are you sure you want to delete this diocese?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                                {% endif %}
                                
                                <td style="padding: 12px; border: 1px solid #374151; background: rgba(59, 130, 246, 0.1);">
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #ffffff; font-size: 1.05em;">{{ pastorate.name }}</strong><br>
                                        <small style="color: #e5e7eb;">Pastor: {{ pastorate.pastor_name }}</small>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <a href="{% url 'church_structure:pastorate_detail' pastorate_slug=pastorate.slug %}" 
                                           class="btn btn-sm" style="background: #3b82f6; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="View Pastorate Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'church_structure:edit_pastorate' pastorate_slug=pastorate.slug %}" 
                                           class="btn btn-sm" style="background: #f59e0b; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Edit Pastorate">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'church_structure:delete_pastorate' pastorate_slug=pastorate.slug %}" 
                                           class="btn btn-sm" style="background: #ef4444; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                           title="Delete Pastorate"
                                           onclick="return confirm('Are you sure you want to delete this pastorate?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                                
                                <td style="padding: 12px; border: 1px solid #374151; background: rgba(16, 185, 129, 0.1); color: #9ca3af; font-style: italic;">
                                    <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                    No churches in this pastorate yet
                                </td>
                            </tr>
                            {% endfor %}
                        {% empty %}
                        <tr>
                            <td style="padding: 12px; border: 1px solid #374151; background: rgba(220, 38, 38, 0.1);">
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: #ffffff; font-size: 1.1em;">{{ diocese.name }}</strong><br>
                                    <small style="color: #9ca3af;">{{ diocese.country }}</small><br>
                                    <small style="color: #e5e7eb;">Bishop: {{ diocese.bishop_name }}</small>
                                </div>
                                <div style="margin-top: 10px;">
                                    <a href="{% url 'church_structure:diocese_detail' diocese_slug=diocese.slug %}" 
                                       class="btn btn-sm" style="background: #3b82f6; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                       title="View Diocese Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'church_structure:edit_diocese' diocese_slug=diocese.slug %}" 
                                       class="btn btn-sm" style="background: #f59e0b; color: white; margin-right: 5px; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                       title="Edit Diocese">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'church_structure:delete_diocese' diocese_slug=diocese.slug %}" 
                                       class="btn btn-sm" style="background: #ef4444; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px;"
                                       title="Delete Diocese"
                                       onclick="return confirm('Are you sure you want to delete this diocese?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                            <td style="padding: 12px; border: 1px solid #374151; background: rgba(59, 130, 246, 0.1); color: #9ca3af; font-style: italic;" colspan="2">
                                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                No pastorates in this diocese yet
                            </td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 40px;">
            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 15px; display: block;"></i>
            No church structure data available yet. Start by adding dioceses.
        </div>
        {% endif %}
    </div>
</div>

<script>
// Cascading dropdown functionality
document.getElementById('diocese-select').addEventListener('change', function() {
    const dioceseId = this.value;
    const pastorateSelect = document.getElementById('pastorate-select');
    
    // Clear pastorate dropdown
    pastorateSelect.innerHTML = '<option value="">Select Pastorate</option>';
    
    if (dioceseId) {
        // Fetch pastorates for selected diocese
        fetch(`/church-structure/api/pastorates/${dioceseId}/`)
            .then(response => response.json())
            .then(data => {
                data.forEach(pastorate => {
                    const option = document.createElement('option');
                    option.value = pastorate.id;
                    option.textContent = pastorate.name;
                    pastorateSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error:', error));
    }
});
</script>
{% endblock %}
